---
title: "STITCH: Sample Alignment and Coverage Summary"
output: 
  html_document:
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(vroom)
library(purrr)
library(dplyr)
library(tidyr)
library(plotly)
summaryPlotTheme <- theme_bw() + 
  theme(panel.grid = element_blank(),
        axis.title = element_text(colour = "black"),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())
```

```{r read in alignment summaries}
# set the path to alignment summaries
alignment_summary_path <- "../../data/DO_4WC_MiSeq/4WC_MiSeq/alignment_stats/"

# find alignment summaries
alignment_summaries <- list.files(alignment_summary_path)


concatenateSummaries <- function(summary){
  # Read in alignment summaries
  metrics <- suppressMessages(vroom::vroom(paste0(alignment_summary_path,summary), col_names = F))
  colnames(metrics) <- c("metric","value")
  
  # Extract sample name
  sampleName <- gsub(summary, pattern = "_summary_stats.txt", replacement = "")
  
  # Attach sample name to metric
  metrics$sample <- sampleName
  
  return(metrics)
  
}

# Collect summary stats for all samples
allSummaries <- purrr::map_dfr(alignment_summaries, concatenateSummaries)

# Find alignment percentages among all metrics
allSummaries$pct <- unlist(lapply(X = allSummaries$metric, function(x) strsplit(x, split = "_")[[1]][1]))
allSummaries$pct[which(allSummaries$pct != "PCT")] <- ""
percentages <- allSummaries %>%
  dplyr::filter(pct == "PCT")
  
# Remove metrics with percentages
otherMetrics <- allSummaries %>%
  dplyr::filter(pct != "PCT")

# Find coverage metrics
coverage <- otherMetrics[grep(x = otherMetrics$metric, pattern = "COVERAGE"),]
```

```{r plot HQ reads}
# Plot aligned reads that passed filter
total_number_of_reads <- otherMetrics %>%
  dplyr::filter(metric == "Total number of HQ filtered reads") %>%
  ggplot(., mapping = aes(x = reorder(sample, value), 
                          y = value, 
                          text = sample)) + 
  theme_bw() + 
  geom_point() +
  summaryPlotTheme + 
  labs(x = "Sample",
       y = "Total number of HQ filtered reads",
       title = "Total number of HQ filtered reads")
  
plotly::ggplotly(total_number_of_reads, tooltip = c("text","y"))

```


```{r plot aligned reads}
# Plot aligned reads that passed filter
pf_reads_aligned <- otherMetrics %>%
  dplyr::filter(metric == "PF_READS_ALIGNED") %>%
  ggplot(., mapping = aes(x = reorder(sample, value), 
                          y = value, 
                          text = sample)) + 
  theme_bw() + 
  geom_point() +
  summaryPlotTheme + 
  labs(x = "Sample",
       y = "PF_READS_ALIGNED",
       title = "Passing Filter Reads Aligned")
  
plotly::ggplotly(pf_reads_aligned, tooltip = c("text","y"))

```

```{r plot coverage estimates}
# Plot aligned reads that passed filter
wideCoverage <- coverage %>%
  dplyr::select(-pct) %>%
  tidyr::pivot_wider(names_from = metric, values_from = value)

pf_reads_aligned <- 
  ggplot() + 
  theme_bw() + 
  geom_pointrange(data = wideCoverage, mapping = aes(x = reorder(sample, MEDIAN_COVERAGE), 
                                                     y = MEDIAN_COVERAGE, 
                                                     ymin = MEDIAN_COVERAGE-SD_COVERAGE,
                                                     ymax = MEDIAN_COVERAGE+SD_COVERAGE,
                                                     text = sample)) +
  geom_point(data = wideCoverage, mapping = aes(x = reorder(sample, MEDIAN_COVERAGE), 
                                                y = MEAN_COVERAGE),
             shape = 8, size = 3) + 
  summaryPlotTheme + 
  labs(x = "Sample",
       y = "Coverage",
       title = "Coverage estimates")
  
plotly::ggplotly(pf_reads_aligned, tooltip = c("text","y"))

```
